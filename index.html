<script>
  let saldoAtual = parseFloat(document.getElementById('saldoInicial').value) || 0;
  let acumuladoTotal = 0;
  let contadorApostas = 0; // Contador para a linha do tempo

  document.getElementById('saldoAtualDisplay').textContent = formatMoney(saldoAtual);
  document.getElementById('acumuladoDisplay').textContent = formatMoney(acumuladoTotal);

  function formatMoney(v){
    return 'R$ ' + Number(v || 0).toFixed(2);
  }

  function calcular(){
    const timeCasa = document.getElementById('timeCasa').value || 'Time A';
    const timeVis = document.getElementById('timeVisitante').value || 'Time B';

    const odd1 = parseFloat(document.getElementById('odd1').value) || 0;
    const odd2 = parseFloat(document.getElementById('odd2').value) || 0;

    const saldoInicial = parseFloat(document.getElementById('saldoInicial').value) || 0;
    let stake = parseFloat(document.getElementById('valorAposta').value) || 0;

    const multVitoria = parseFloat(document.getElementById('multVitoria').value) || 1;
    const multUma = parseFloat(document.getElementById('multUma').value) || 1;
    const multPerda = parseFloat(document.getElementById('multPerda').value) || 0;

    const erros = parseInt(document.getElementById('erros').value, 10);

    if(stake > saldoInicial){
      alert('Atenção: o valor da aposta (stake) é maior que o saldo da banca.');
    }

    let multAplicado = 1;
    if(erros === 0) multAplicado = multVitoria;
    else if(erros === 1) multAplicado = multUma;
    else if(erros === 2) multAplicado = multPerda;

    const retorno = stake * multAplicado;
    const novoSaldo = (saldoInicial - stake) + retorno;

    saldoAtual = novoSaldo;

    // Exibir detalhes da rodada
    const detalhesEl = document.getElementById('detalhes');
    detalhesEl.innerHTML = `
      <div class="line"><div><strong>Partida:</strong></div><div>${escapeHtml(timeCasa)} x ${escapeHtml(timeVis)}</div></div>
      <div class="line"><div class="muted">Odds:</div><div>${odd1 ? odd1 : '-'} / ${odd2 ? odd2 : '-'}</div></div>
      <div class="line"><div class="muted">Stake (valor da aposta):</div><div>${formatMoney(stake)}</div></div>
      <div class="line"><div class="muted">Multiplicador aplicado:</div><div><strong>${multAplicado}</strong></div></div>
      <div class="line"><div class="muted">Retorno (stake × multiplicador):</div><div><strong>${formatMoney(retorno)}</strong></div></div>
      <div class="line"><div class="muted">Saldo anterior:</div><div>${formatMoney(saldoInicial)}</div></div>
      <div class="line"><div class="muted">Novo saldo da banca:</div><div class="saldo">${formatMoney(novoSaldo)}</div></div>
    `;

    document.getElementById('saldoAtualDisplay').textContent = formatMoney(saldoAtual);

    // Adiciona ao histórico com linha colorida
    const tbody = document.getElementById('historicoBody');
    contadorApostas++;
    const tr = document.createElement('tr');

    // Define cor da linha: verde = lucro, vermelho = prejuízo
    let corLinha = retorno >= stake ? '#1f7a1f' : '#b91c1c';
    tr.style.backgroundColor = corLinha;
    tr.style.color = '#fff'; // Texto branco para contraste
    tr.style.fontWeight = '600';

    tr.innerHTML = `
      <td style="padding:6px;">#${contadorApostas} - ${escapeHtml(timeCasa)} x ${escapeHtml(timeVis)}</td>
      <td style="text-align:right; padding:6px;">${formatMoney(stake)}</td>
      <td style="text-align:right; padding:6px;">${multAplicado}</td>
      <td style="text-align:right; padding:6px;">${formatMoney(retorno)}</td>
      <td style="text-align:right; padding:6px;">${formatMoney(novoSaldo)}</td>
    `;
    tbody.appendChild(tr);
  }

  function acumularSaldo(){
    acumuladoTotal = (acumuladoTotal || 0) + (saldoAtual || 0);
    document.getElementById('acumuladoDisplay').textContent = formatMoney(acumuladoTotal);
    alert('Saldo atual acumulado no total: ' + formatMoney(acumuladoTotal));
  }

  function resetarOdds(){
    document.getElementById('odd1').value = '';
    document.getElementById('odd2').value = '';
  }

  function limparCampos(){
    document.getElementById('odd1').value = '';
    document.getElementById('odd2').value = '';
    document.getElementById('saldoInicial').value = 0;
    document.getElementById('valorAposta').value = 0;
    document.getElementById('multVitoria').value = 1.5;
    document.getElementById('multUma').value = 1.1;
    document.getElementById('multPerda').value = 0;
    document.getElementById('erros').value = '0';
    document.getElementById('detalhes').innerHTML = '';
    document.getElementById('historicoBody').innerHTML = '';
    saldoAtual = 0;
    acumuladoTotal = 0;
    contadorApostas = 0;
    document.getElementById('saldoAtualDisplay').textContent = formatMoney(saldoAtual);
    document.getElementById('acumuladoDisplay').textContent = formatMoney(acumuladoTotal);
  }

  function escapeHtml(text) {
    return String(text)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  document.getElementById('saldoInicial').addEventListener('input', function(){
    const v = parseFloat(this.value) || 0;
    saldoAtual = v;
    document.getElementById('saldoAtualDisplay').textContent = formatMoney(saldoAtual);
  });
</script>
